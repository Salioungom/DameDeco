'use client';

import { useState, useEffect } from 'react';
import {
  Box,
  Container,
  Typography,
  Button,
  Chip,
  Divider,
  Tabs,
  Tab,
  Stack,
  IconButton,
  CircularProgress,
} from '@mui/material';
import {
  ShoppingCart,
  Remove as Minus,
  Add as Plus,
  ArrowBack as ArrowLeft,
  Inventory2 as Package,
  LocalShipping as Truck,
  Cached as RefreshCw,
  WhatsApp as MessageCircle,
  Favorite as Heart,
  FavoriteBorder as HeartOutline,
} from '@mui/icons-material';
import { Product } from '../types/product';
import { productService } from '../services/product.service';
import { ImageWithFallback } from './figma/ImageWithFallback';
import { orderViaWhatsApp } from '../lib/whatsapp';
import ProductCard from './ProductCard';

interface ProductDetailPageProps {
  product: Product;
  onAddToCart: (product: Product, quantity: number) => void;
  onBack: () => void;
  userType: 'retail' | 'wholesale';
  favorites: string[];
  onToggleFavorite: (productId: string) => void;
  onViewProduct: (product: Product) => void;
  onAddReview?: (review: any) => void;
}

interface TabPanelProps {
  children?: React.ReactNode;
  index: number;
  value: number;
}

function CustomTabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props;

  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`simple-tabpanel-${index}`}
      aria-labelledby={`simple-tab-${index}`}
      {...other}
    >
      {value === index && <Box sx={{ py: 3 }}>{children}</Box>}
    </div>
  );
}

export function ProductDetailPage({
  product,
  onAddToCart,
  onBack,
  userType,
  favorites,
  onToggleFavorite,
  onViewProduct,
  onAddReview,
}: ProductDetailPageProps) {
  const [quantity, setQuantity] = useState(1);
  const [selectedImage, setSelectedImage] = useState(0);
  const [tabValue, setTabValue] = useState(0);
  const [similarProducts, setSimilarProducts] = useState<Product[]>([]);
  const [loadingSimilar, setLoadingSimilar] = useState(true);

  const price = userType === 'wholesale' && product.wholesale_price ? product.wholesale_price : product.price;

  // Fetch similar products
  useEffect(() => {
    let mounted = true;
    const fetchSimilar = async () => {
      try {
        setLoadingSimilar(true);
        const response = await productService.getProducts({
          category_id: product.category_id,
          limit: 5
        });
        if (mounted) {
          setSimilarProducts(response.items.filter(p => p.id !== product.id).slice(0, 4));
        }
      } catch (error) {
        console.error("Failed to fetch similar products", error);
      } finally {
        if (mounted) setLoadingSimilar(false);
      }
    };

    if (product.category_id) {
      fetchSimilar();
    } else {
      setLoadingSimilar(false);
    }

    return () => { mounted = false; };
  }, [product.category_id, product.id]);

  const images = product.images?.map(img => img.image_url) || (product.cover_image_url ? [product.cover_image_url] : []);
  const displayImage = images[selectedImage] || product.cover_image_url || '';

  const handleWhatsAppOrder = () => {
    orderViaWhatsApp(product.name, price, quantity, displayImage, product.id);
  };

  const handleTabChange = (event: React.SyntheticEvent, newValue: number) => {
    setTabValue(newValue);
  };

  return (
    <Box sx={{ minHeight: '100vh', py: 4, bgcolor: 'background.default' }}>
      <Container maxWidth="xl">
        <Button
          startIcon={<ArrowLeft />}
          onClick={onBack}
          sx={{ mb: 4, color: 'text.secondary' }}
        >
          Retour à la boutique
        </Button>

        {/* Main 2-Column Layout */}
        <Box
          sx={{
            display: 'grid',
            gridTemplateColumns: { xs: '1fr', lg: '60fr 40fr' },
            gap: 4,
          }}
        >
          {/* Left Column - Gallery (60%) */}
          <Box>
            <Stack spacing={2}>
              {/* Main Image */}
              <Box
                sx={{
                  position: 'relative',
                  paddingTop: '100%',
                  borderRadius: 3,
                  overflow: 'hidden',
                  bgcolor: 'background.paper',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.08)',
                }}
              >
                <Box
                  sx={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    width: '100%',
                    height: '100%',
                  }}
                >
                  <ImageWithFallback
                    src={displayImage}
                    alt={product.name}
                    style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                  />
                </Box>

                {/* Image Counter Overlay */}
                {images.length > 1 && (
                  <Chip
                    label={`${selectedImage + 1} / ${images.length}`}
                    size="small"
                    sx={{
                      position: 'absolute',
                      bottom: 16,
                      right: 16,
                      bgcolor: 'rgba(0,0,0,0.7)',
                      color: 'white',
                      fontWeight: 600,
                      fontSize: '0.813rem',
                    }}
                  />
                )}
              </Box>

              {/* Thumbnail Gallery */}
              {images.length > 1 && (
                <Box sx={{ display: 'flex', gap: 1.5, flexWrap: 'wrap' }}>
                  {images.map((image, index) => (
                    <Box
                      key={index}
                      component="button"
                      onClick={() => setSelectedImage(index)}
                      sx={{
                        width: 80,
                        height: 80,
                        position: 'relative',
                        borderRadius: 2,
                        overflow: 'hidden',
                        border: '2px solid',
                        borderColor: selectedImage === index ? 'golden.main' : 'transparent',
                        cursor: 'pointer',
                        transition: 'all 0.3s ease',
                        bgcolor: 'background.paper',
                        padding: 0,
                        '&:hover': {
                          borderColor: selectedImage === index ? 'golden.main' : 'golden.light',
                          transform: 'scale(1.05)',
                        },
                      }}
                    >
                      <ImageWithFallback
                        src={image}
                        alt={`${product.name} ${index + 1}`}
                        style={{ width: '100%', height: '100%', objectFit: 'cover' }}
                      />
                    </Box>
                  ))}
                </Box>
              )}
            </Stack>
          </Box>

          {/* Right Column - Product Info (40%) */}
          <Box>
            <Stack spacing={3}>
              {/* Badges */}
              <Stack direction="row" spacing={1} flexWrap="wrap" gap={1}>
                {product.is_featured && (
                  <Chip
                    label="Populaire"
                    size="small"
                    sx={{
                      bgcolor: '#FFF3CD',
                      color: '#856404',
                      fontWeight: 600,
                      fontSize: '0.75rem',
                      height: 24,
                    }}
                  />
                )}
                {product.pieces && (
                  <Chip
                    label={`${product.pieces} pièces`}
                    size="small"
                    sx={{
                      bgcolor: '#E9ECEF',
                      color: '#495057',
                      fontWeight: 600,
                      fontSize: '0.75rem',
                      height: 24,
                    }}
                  />
                )}
                {product.is_new && (
                  <Chip
                    label="Nouveau"
                    size="small"
                    color="primary"
                    sx={{ fontWeight: 600, fontSize: '0.75rem', height: 24 }}
                  />
                )}
                {product.inventory_quantity < 20 && product.inventory_quantity > 0 && (
                  <Chip
                    label="Stock limité"
                    size="small"
                    color="error"
                    sx={{ fontWeight: 600, fontSize: '0.75rem', height: 24 }}
                  />
                )}
              </Stack>

              {/* Title */}
              <Typography
                variant="h4"
                component="h1"
                sx={{
                  fontSize: { xs: '1.75rem', md: '1.75rem' },
                  fontWeight: 700,
                  lineHeight: 1.2,
                  mb: 1,
                }}
              >
                {product.name}
              </Typography>

              {/* Price Section */}
              <Box>
                <Stack direction="row" alignItems="baseline" spacing={2} flexWrap="wrap" mb={1.5}>
                  {/* Current Price - Golden */}
                  <Typography
                    variant="h5"
                    sx={{
                      color: 'golden.main',
                      fontWeight: 700,
                      fontSize: { xs: '1.5rem', md: '1.625rem' },
                    }}
                  >
                    {price.toLocaleString('fr-FR')} FCFA
                  </Typography>

                  {/* Original Price - Strike through */}
                  {product.original_price && userType !== 'wholesale' && (
                    <Typography
                      variant="h6"
                      sx={{
                        color: 'text.secondary',
                        textDecoration: 'line-through',
                        fontSize: '1.125rem',
                      }}
                    >
                      {product.original_price.toLocaleString('fr-FR')} FCFA
                    </Typography>
                  )}
                  {userType === 'wholesale' && (
                    <Typography
                      variant="h6"
                      sx={{
                        color: 'text.secondary',
                        textDecoration: 'line-through',
                        fontSize: '1.125rem',
                      }}
                    >
                      {product.price.toLocaleString('fr-FR')} FCFA
                    </Typography>
                  )}
                </Stack>

                {/* Discount Badge and Savings */}
                {product.original_price && userType !== 'wholesale' && (
                  <Stack direction="row" alignItems="center" spacing={1.5} flexWrap="wrap">
                    <Chip
                      label={`-${Math.round(((product.original_price - product.price) / product.original_price) * 100)}% DE RÉDUCTION`}
                      sx={{
                        bgcolor: 'error.main',
                        color: 'white',
                        fontWeight: 600,
                        fontSize: '0.75rem',
                        height: 26,
                      }}
                    />
                    <Typography variant="body2" color="text.secondary" sx={{ fontSize: '0.813rem' }}>
                      Économisez {(product.original_price - product.price).toLocaleString('fr-FR')} FCFA
                    </Typography>
                  </Stack>
                )}

                {userType === 'wholesale' && (
                  <Chip
                    label="Prix grossiste appliqué"
                    color="secondary"
                    size="small"
                    sx={{ mt: 1 }}
                  />
                )}
              </Box>

              {/* Short Description */}
              <Typography
                variant="body1"
                color="text.secondary"
                sx={{
                  lineHeight: 1.6,
                  fontSize: '0.938rem',
                }}
              >
                {product.short_description || product.description}
              </Typography>

              <Divider />

              {/* Quantity Selector */}
              <Box>
                <Stack direction="row" alignItems="center" spacing={2} flexWrap="wrap">
                  <Typography variant="subtitle1" fontWeight={600}>
                    Quantité :
                  </Typography>
                  <Stack direction="row" alignItems="center" spacing={1}>
                    <IconButton
                      onClick={() => setQuantity(Math.max(1, quantity - 1))}
                      size="small"
                      sx={{
                        border: 1,
                        borderColor: 'divider',
                        borderRadius: 2,
                        width: 32,
                        height: 32,
                      }}
                    >
                      <Minus fontSize="small" />
                    </IconButton>
                    <Typography
                      sx={{
                        minWidth: 40,
                        textAlign: 'center',
                        fontWeight: 600,
                        fontSize: '1rem',
                      }}
                    >
                      {quantity}
                    </Typography>
                    <IconButton
                      onClick={() => setQuantity(quantity + 1)}
                      disabled={quantity >= product.inventory_quantity}
                      size="small"
                      sx={{
                        border: 1,
                        borderColor: 'divider',
                        borderRadius: 2,
                        width: 32,
                        height: 32,
                      }}
                    >
                      <Plus fontSize="small" />
                    </IconButton>
                  </Stack>
                  <Typography variant="body2" color="text.secondary" sx={{ fontSize: '0.875rem' }}>
                    {product.inventory_quantity} en stock
                  </Typography>
                </Stack>
              </Box>

              {/* CTA Buttons */}
              <Stack direction={{ xs: 'column', sm: 'row' }} spacing={2}>
                <Button
                  variant="contained"
                  size="large"
                  startIcon={<ShoppingCart />}
                  onClick={() => onAddToCart(product, quantity)}
                  disabled={product.inventory_quantity === 0}
                  sx={{
                    flex: 1,
                    py: 1.5,
                    borderRadius: 2,
                    fontWeight: 600,
                    fontSize: '0.938rem',
                  }}
                >
                  Ajouter au panier
                </Button>
                <Button
                  variant="outlined"
                  size="large"
                  color="success"
                  startIcon={<MessageCircle />}
                  onClick={handleWhatsAppOrder}
                  sx={{
                    borderRadius: 2,
                    fontWeight: 600,
                    fontSize: '0.938rem',
                    minWidth: { xs: '100%', sm: 140 },
                    borderWidth: 2,
                    '&:hover': {
                      borderWidth: 2,
                    },
                  }}
                >
                  WhatsApp
                </Button>
              </Stack>

              <Divider />

              {/* Delivery Info */}
              <Stack spacing={2}>
                <Stack direction="row" spacing={2} alignItems="center">
                  <Package sx={{ color: 'primary.main', fontSize: 24 }} />
                  <Typography variant="body2" sx={{ fontSize: '0.875rem' }}>
                    Import direct depuis la Chine – Qualité garantie
                  </Typography>
                </Stack>
                <Stack direction="row" spacing={2} alignItems="center">
                  <Truck sx={{ color: 'primary.main', fontSize: 24 }} />
                  <Typography variant="body2" sx={{ fontSize: '0.875rem' }}>
                    Livraison à Dakar et dans toute la sous-région
                  </Typography>
                </Stack>
                <Stack direction="row" spacing={2} alignItems="center">
                  <RefreshCw sx={{ color: 'primary.main', fontSize: 24 }} />
                  <Typography variant="body2" sx={{ fontSize: '0.875rem' }}>
                    Retour possible sous 7 jours
                  </Typography>
                </Stack>
              </Stack>

              <Divider />

              {/* Tabs */}
              <Box sx={{ width: '100%' }}>
                <Box sx={{ borderBottom: 1, borderColor: 'divider' }}>
                  <Tabs
                    value={tabValue}
                    onChange={handleTabChange}
                    aria-label="product tabs"
                    variant="scrollable"
                    scrollButtons="auto"
                    sx={{
                      '& .MuiTab-root': {
                        fontWeight: 600,
                        fontSize: '0.938rem',
                        textTransform: 'none',
                      },
                    }}
                  >
                    <Tab label="Description" />
                    <Tab label="Avis (3)" />
                    <Tab label="Livraison" />
                    <Tab label="Paiement" />
                  </Tabs>
                </Box>

                {/* Description Tab */}
                <CustomTabPanel value={tabValue} index={0}>
                  <Typography paragraph sx={{ lineHeight: 1.7, fontSize: '0.938rem' }}>
                    {product.description || product.short_description || 'Magnifiques rideaux occultants en tissu de haute qualité. Set de 3 pièces parfait pour salon ou chambre. Design élégant et moderne.'}
                  </Typography>
                  <Typography variant="subtitle1" gutterBottom fontWeight={700} sx={{ mt: 2, mb: 1.5 }}>
                    Caractéristiques :
                  </Typography>
                  <Box component="ul" sx={{ pl: 3, '& li': { mb: 1 } }}>
                    <li>
                      <Typography variant="body2" sx={{ fontSize: '0.875rem', lineHeight: 1.6 }}>
                        Importé directement de Chine
                      </Typography>
                    </li>
                    <li>
                      <Typography variant="body2" sx={{ fontSize: '0.875rem', lineHeight: 1.6 }}>
                        Qualité premium contrôlée
                      </Typography>
                    </li>
                    {product.pieces && (
                      <li>
                        <Typography variant="body2" sx={{ fontSize: '0.875rem', lineHeight: 1.6 }}>
                          Ensemble de {product.pieces} pièces
                        </Typography>
                      </li>
                    )}
                    <li>
                      <Typography variant="body2" sx={{ fontSize: '0.875rem', lineHeight: 1.6 }}>
                        Matériaux de haute qualité
                      </Typography>
                    </li>
                    {product.weight && (
                      <li>
                        <Typography variant="body2" sx={{ fontSize: '0.875rem', lineHeight: 1.6 }}>
                          Poids: {product.weight} kg
                        </Typography>
                      </li>
                    )}
                    {product.dimensions && (
                      <li>
                        <Typography variant="body2" sx={{ fontSize: '0.875rem', lineHeight: 1.6 }}>
                          Dimensions: {product.dimensions}
                        </Typography>
                      </li>
                    )}
                  </Box>
                </CustomTabPanel>

                {/* Reviews Tab */}
                <CustomTabPanel value={tabValue} index={1}>
                  <Typography variant="body2" color="text.secondary">
                    Les avis seront bientôt disponibles.
                  </Typography>
                </CustomTabPanel>

                {/* Delivery Tab */}
                <CustomTabPanel value={tabValue} index={2}>
                  <Stack spacing={2}>
                    <Box>
                      <Typography variant="subtitle2" gutterBottom fontWeight={600}>
                        Livraison à Dakar
                      </Typography>
                      <Typography variant="body2" color="text.secondary" sx={{ lineHeight: 1.6 }}>
                        Livraison sous 2-3 jours ouvrables. Frais de livraison calculés au paiement.
                      </Typography>
                    </Box>
                    <Box>
                      <Typography variant="subtitle2" gutterBottom fontWeight={600}>
                        Livraison en Gambie
                      </Typography>
                      <Typography variant="body2" color="text.secondary" sx={{ lineHeight: 1.6 }}>
                        Livraison sous 5-7 jours ouvrables selon la destination.
                      </Typography>
                    </Box>
                    <Box>
                      <Typography variant="subtitle2" gutterBottom fontWeight={600}>
                        Retrait en magasin
                      </Typography>
                      <Typography variant="body2" color="text.secondary" sx={{ lineHeight: 1.6 }}>
                        Gratuit - Disponible sous 24h dans notre boutique à Dakar.
                      </Typography>
                    </Box>
                  </Stack>
                </CustomTabPanel>

                {/* Payment Tab */}
                <CustomTabPanel value={tabValue} index={3}>
                  <Stack spacing={2}>
                    <Box>
                      <Typography variant="subtitle2" gutterBottom fontWeight={600}>
                        Mobile Money
                      </Typography>
                      <Typography variant="body2" color="text.secondary" sx={{ lineHeight: 1.6 }}>
                        Wave et Orange Money acceptés
                      </Typography>
                    </Box>
                    <Box>
                      <Typography variant="subtitle2" gutterBottom fontWeight={600}>
                        PayPal
                      </Typography>
                      <Typography variant="body2" color="text.secondary" sx={{ lineHeight: 1.6 }}>
                        Paiement sécurisé par carte ou compte PayPal
                      </Typography>
                    </Box>
                    <Box>
                      <Typography variant="subtitle2" gutterBottom fontWeight={600}>
                        Paiement à la livraison
                      </Typography>
                      <Typography variant="body2" color="text.secondary" sx={{ lineHeight: 1.6 }}>
                        Payez en espèces à la réception de votre commande
                      </Typography>
                    </Box>
                  </Stack>
                </CustomTabPanel>
              </Box>
            </Stack>
          </Box>
        </Box>

        {/* Similar Products */}
        {
          loadingSimilar ? (
            <Box display="flex" justifyContent="center" my={8}>
              <CircularProgress />
            </Box>
          ) : similarProducts.length > 0 && (
            <Box mt={8}>
              <Divider sx={{ mb: 4 }} />
              <Box mb={4}>
                <Typography variant="h4" gutterBottom fontWeight={700}>
                  Produits Similaires
                </Typography>
                <Typography variant="body1" color="text.secondary">
                  Découvrez d'autres produits de la même catégorie
                </Typography>
              </Box>
              <Box
                sx={{
                  display: 'grid',
                  gridTemplateColumns: { xs: '1fr', sm: '1fr 1fr', lg: 'repeat(4, 1fr)' },
                  gap: 3,
                }}
              >
                {similarProducts.map((similarProduct) => (
                  <div key={similarProduct.id}>
                    <ProductCard
                      product={similarProduct}
                      onAddToCart={(p) => onAddToCart(p, 1)}
                      onViewDetails={onViewProduct}
                      userType={userType}
                      isFavorite={favorites.includes(similarProduct.id)}
                      onToggleFavorite={onToggleFavorite}
                    />
                  </div>
                ))}
              </Box>
            </Box>
          )
        }
      </Container >
    </Box >
  );
}
